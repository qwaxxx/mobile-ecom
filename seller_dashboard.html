<!DOCTYPE html>
<html lang="en">

<head>
    <title>Dashboard</title>
    <!-- [Meta] -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="Mantis is made using Bootstrap 5 design framework. Download the free admin template & use it for your project.">
    <meta name="keywords" content="Mantis, Dashboard UI Kit, Bootstrap 5, Admin Template, Admin Dashboard, CRM, CMS, Bootstrap Admin Template">
    <meta name="author" content="CodedThemes">

    <!-- [Favicon] icon -->
    <link rel="icon" href="asset/images/favicon.svg" type="image/x-icon">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@300;400;500;600;700&display=swap">
    <link rel="stylesheet" href="asset/fonts/tabler-icons.min.css">
    <link rel="stylesheet" href="asset/fonts/feather.css">
    <link rel="stylesheet" href="asset/fonts/fontawesome.css">
    <link rel="stylesheet" href="asset/fonts/material.css">
    <link rel="stylesheet" href="asset/css/style.css">
    <link rel="stylesheet" href="asset/css/style-preset.css">
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/mdb.min.css">
    <link rel="stylesheet" href="css/style.min.css">

    <style>
        .modal1 {
            display: block !important;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
        }
    </style>
</head>

<body data-pc-preset="preset-1" data-pc-direction="ltr" data-pc-theme="light">
    <!-- [ Pre-loader ] start -->
    <div class="loader-bg">
        <div class="loader-track">
            <div class="loader-fill"></div>
        </div>
    </div>
    <!-- [ Pre-loader ] End -->

    <?php include("seller_slidebar.php") ?>
    <!-- [ Header Topbar ] start -->

  <header class="pc-header">
  <div class="header-wrapper"> <!-- [Mobile Media Block] start -->
    <div class="me-auto pc-mob-drp">
      <ul class="list-unstyled">
        <!-- ======= Menu collapse Icon ===== -->
        <li class="pc-h-item pc-sidebar-collapse">
          <a href="#" class="pc-head-link ms-0" id="sidebar-hide">
            <i class="ti ti-menu-2"></i>
          </a>
        </li>
        <li class="pc-h-item pc-sidebar-popup">
          <a href="#" class="pc-head-link ms-0" id="mobile-collapse">
            <i class="ti ti-menu-2"></i>
          </a>
        </li>
        <li class="dropdown pc-h-item d-inline-flex d-md-none">
          <a
            class="pc-head-link dropdown-toggle arrow-none m-0"
            data-bs-toggle="dropdown"
            href="#"
            role="button"
            aria-haspopup="false"
            aria-expanded="false">
            <i class="ti ti-search"></i>
          </a>
          <div class="dropdown-menu pc-h-dropdown drp-search">
            <form class="px-3">
              <div class="form-group mb-0 d-flex align-items-center">
                <i data-feather="search"></i>
                <input type="search" class="form-control border-0 shadow-none" placeholder="Search here. . .">
              </div>
            </form>
          </div>
        </li>
        <li class="pc-h-item d-none d-md-inline-flex">
          <form class="header-search">
            <i data-feather="search" class="icon-search"></i>
            <input type="search" class="form-control" placeholder="Search here. . .">
          </form>
        </li>
      </ul>
    </div>
    <!-- [Mobile Media Block end] -->
    <div class="ms-auto">
      <ul class="list-unstyled">

        <li class="dropdown pc-h-item">
          <a class="pc-head-link dropdown-toggle arrow-none position-relative" data-bs-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">
            <i class="ti ti-bell fs-5"></i>
            <span id="notificationBadge" class="badge bg-danger rounded-pill position-absolute top-70 start-95 translate-middle"  >0</span>
          </a>

          <div class="dropdown-menu dropdown-menu-end pc-h-dropdown shadow dropdown-notification">
            <div class="dropdown-header d-flex align-items-center justify-content-between px-3 py-2">
              <h6 class="mb-0 fw-semibold text-dark">Notifications</h6>
              <a href="#" class="text-danger" onclick="clearNotifications(event)">
                <i class="ti ti-x fs-6"></i>
              </a>
            </div>
            <div class="dropdown-divider my-0"></div>

            <div class="px-2 py-1 overflow-auto" style="max-height: calc(100vh - 215px);" id="notificationList">
            
            </div>

            <div class="dropdown-divider my-0"></div>
            <div class="text-center py-2">
              <a href="#" class="text-primary fw-semibold small">View All</a>
            </div>
          </div>
        </li>


        <li class="dropdown pc-h-item header-user-profile">
          <a
            class="pc-head-link dropdown-toggle arrow-none me-0"
            data-bs-toggle="dropdown"
            href="#"
            role="button"
            aria-haspopup="false"
            data-bs-auto-close="outside"
            aria-expanded="false">
            <img src="" alt="user-image" class="user-avtar">
            <span></span>
          </a>
          <div class="dropdown-menu dropdown-user-profile dropdown-menu-end pc-h-dropdown">
            <div class="tab-content" id="mysrpTabContent">
              <div class="tab-pane fade show active" id="drp-tab-1" role="tabpanel" aria-labelledby="drp-t1" tabindex="0">
                <a href="seller_profile.html" class="dropdown-item">
                  <i class="ti ti-user"></i>
                  <span>View Profile</span>
                </a>
                <a href="#" id="logoutBtn1" class="dropdown-item">
                  <i class="ti ti-power"></i>
                  <span>Logout</span>
                </a>
              </div>
            </div>
          </div>
        </li>
      </ul>
    </div>
  </div>
</header>
<!-- [ Header ] end -->

    <!-- [ Main Content ] start -->
    <div class="pc-container">
        <div class="pc-content">
            <div class="container">
                <!-- Navbar -->
                <nav class="navbar navbar-expand-lg navbar-dark mdb-color lighten-3 mt-3 mb-5">
                    <span class="navbar-brand">Categories:</span>
                    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#basicExampleNav" aria-controls="basicExampleNav" aria-expanded="false" aria-label="Toggle navigation">
                        <span class="navbar-toggler-icon"></span>
                    </button>
                    <div class="collapse navbar-collapse" id="basicExampleNav">
                        <ul class="navbar-nav mr-auto">
                            <li class="nav-item active">
                                <a class="nav-link" id="showAll" href="#">All <span class="sr-only">(current)</span></a>
                            </li>
                            <li class="nav-item">
                                <select class="form-control nav-link lighten-3" name="price_range" id="price_range" style="color:aqua;height:42px;margin-left:2px">
                                    <option value="">Select price range</option>
                                    <option value="0-10000">₱0 - ₱10000</option>
                                    <option value="10001-20000">₱10001 - ₱20000</option>
                                    <option value="20001-30000">₱20001 - ₱30000</option>
                                    <option value="30001-130000">₱30001 - ₱130000</option>
                                </select>
                            </li>
                        </ul>
                        <a class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addproduct">+ Add product</a>
                        <form class="form-inline ml-auto">
                            <div class="md-form my-0">
                                <input class="form-control form-control-sm" type="text" placeholder="Search" id="search" aria-label="Search">
                            </div>
                        </form>
                    </div>
                </nav>

                <div id="productContainer"></div>

                <!-- Pagination -->
                <div class="d-flex justify-content-center mt-3">
                    <nav>
                        <ul class="pagination" id="pagination"></ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
    <!-- [ Main Content ] end -->

    <!-- Modal for adding products -->
    <div class="modal fade" id="addproduct" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Add Items to Sell</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addProductForm" enctype="multipart/form-data">
                        <div class="form-group">
                            <label for="prod_name">Product Name</label>
                            <input type="text" name="prod_name" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="prod_price">Price</label>
                            <input type="number" name="prod_price" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="prod_stock">Stock</label>
                            <input type="number" name="prod_stock" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="prod_description">Description</label>
                            <textarea name="prod_description" class="form-control" rows="3" required></textarea>
                        </div>
                        <div class="form-group">
                            <label for="prod_picture">Product Image</label>
                            <input type="file" name="prod_picture" class="form-control-file" accept="image/*" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Add Product</button>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
     <script type="text/javascript" src="js/jquery-3.4.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- JQuery -->
   
    <script>
  document.getElementById('logoutBtn').addEventListener('click', function(e) {
    e.preventDefault();
    Swal.fire({
      title: 'Are you sure?',
      text: "You will be logged out!",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#d33',
      cancelButtonColor: '#6c757d',
      confirmButtonText: 'Yes, logout',
      background: '#ffffff',
      color: '#000000'
    }).then((result) => {
      if (result.isConfirmed) {
        localStorage.removeItem('user_id');
        window.location.href = 'login_page.html'; // Your actual logout script
      }
    });
  });
  document.getElementById('logoutBtn1').addEventListener('click', function(e) {
    e.preventDefault();
    Swal.fire({
      title: 'Are you sure?',
      text: "You will be logged out!",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#d33',
      cancelButtonColor: '#6c757d',
      confirmButtonText: 'Yes, logout',
      background: '#ffffff',
      color: '#000000'
    }).then((result) => {
      if (result.isConfirmed) {
        localStorage.removeItem('user_id');
        window.location.href = 'login_page.html'; // Your actual logout script
      }
    });
  });
</script>
 <script>
    function loadNotifications(all = false) {
      const userId = localStorage.getItem('user_id');
      updateCartBadge()
      const url = all ?
        `api/fetch_notification.php?all=1&user_id=${userId}` :
        `api/fetch_notification.php?&user_id=${userId}`;

      fetch(url)
      
        .then(res => res.json())
        .then(data => {
          alert(data.unread_count);
          const badge = document.getElementById("notificationBadge");
          const dd = document.getElementById("notificationList");

          // 1) Update badge with unread_count
          badge.textContent = data.unread_count;
          // 2) Build dropdown list of all notifications
          dd.innerHTML = '';
          if (data.notifications.length === 0) {
            dd.innerHTML = '<li><a class="dropdown-item text-muted" href="#">No notifications</a></li>';
            return;
          }

          data.notifications.forEach(n => {
            const readClass = n.status === 'unread' ? 'fw-bold' : '';
            const li = document.createElement('li');
            li.innerHTML = `
          <a class="dropdown-item ${readClass}"
             href="#"
             onclick="handleNotificationClick(${n.id}, ${n.addcart_id})">
            ${n.message}
          </a><span style="font-size: 9px; display: inline-block; text-align: right; width: 100%; margin-right: 5px;">${n.created_at}</span>`;
            dd.appendChild(li);
          });

          // 3) “See more” if we hit the 10‑item limit
          if (data.notifications.length > 10 && !all) {
            const more = document.createElement('li');
            more.innerHTML = `
          <a class="dropdown-item text-primary fw-bold"
             href="#"
             onclick="loadNotifications(true)">
            See more
          </a>`;
            dd.appendChild(more);
          }
        });
    } 
        function updateCartBadge() {
            const cart = JSON.parse(localStorage.getItem('cart')) || {};
            let totalItems = 0;
            for (let id in cart) {
                totalItems += cart[id];
            }
            const badge = document.getElementById('cart-badge');
            if (badge) {
                badge.textContent = totalItems > 0 ? totalItems : '';
            }
        }
        updateCartBadge()
    // Example of your existing click‑handler
    function handleNotificationClick(notifId, orderId) {
      const userId = localStorage.getItem('user_id');
      fetch(`api/mark_notification_read.php?user_id=${userId}&notifId=${notifId}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            id: notifId
          })
        })
        .then(r => r.json())
        .then(resp => {
          if (resp.success) {
            document.getElementById("searchInput").value = orderId;
            searchTable();
            loadNotifications(); // refresh both badge & list
          } else {
            alert("Failed to mark as read");
          }
        });
    }
    var lastNotificationTime = 0;

    function getNotification() {
      
      // Check if the browser supports notifications
      if (!("Notification" in window)) {
        $('body').append('<h4 style="color:red">*Browser does not support Web Notification</h4>');
        return;
      }

      // If permission is not granted, request it
      if (Notification.permission !== "granted") {
        Notification.requestPermission();
      } else {
        // Get the current time
        var currentTime = Date.now();
        const userId = localStorage.getItem('user_id');
        // Check if 2 minutes have passed since the last notification
        if (currentTime - lastNotificationTime >= 120000) { // 120000 ms = 2 minutes
          $.ajax({
            url: "api/fetch_notification.php",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify({ user_id: userId }),
            success: function(response) {
              if (response.result === true) {
                var notificationDetails = response.notifications;
                for (var i = notificationDetails.length - 1; i >= 0; i--) {
                  var notificationUrl = notificationDetails[i]['url'];
                  var notificationObj = new Notification(notificationDetails[i]['prod_name'], {
                    body: notificationDetails[i]['message'],
                  });

                  // Set up notification click behavior
                  notificationObj.onclick = function() {
                    window.open(notificationUrl);
                    notificationObj.close();
                  };

                  // Close the notification after 5 seconds
                  setTimeout(function() {
                    notificationObj.close();
                  }, 5000);

                  // Update the last notification time
                  lastNotificationTime = currentTime;
                  break; // Stop once we have sent one notification
                }
              }
            },
            error: function(jqXHR, textStatus, errorThrown) {
              console.error("Error fetching notifications", textStatus, errorThrown);
            }
          });
        }
      }
    }
    getNotification();
    setInterval(function() {
      getNotification();
    }, 20000);
    // Call the notification function every 2 minutes
    document.addEventListener("DOMContentLoaded", () => loadNotifications());
  </script>
    <script>
        $(document).ready(function() {
            loadProducts();

            $('#search').on('keyup', function() {
                loadProducts($('#search').val(), $('#price_range').val(), 1);
            });

            $('#price_range').on('change', function() {
                loadProducts($('#search').val(), $('#price_range').val(), 1);
            });

            $('#showAll').on('click', function(e) {
                e.preventDefault();
                $('#search').val('');
                $('#price_range').val('');
                loadProducts();
            });

            // Handle pagination click (delegate since it’s loaded via AJAX)
            $(document).on('click', '.pagination-link', function(e) {
                e.preventDefault();
                const page = $(this).data('page');
                loadProducts($('#search').val(), $('#price_range').val(), page);
            });

            function loadProducts(search = '', price = '', page = 1) {
                const userId = localStorage.getItem('user_id');
                $.ajax({
                    url: `api/seller_fetch_products.php`,
                    method: 'POST',
                    contentType: 'application/json', // Set content type to JSON
                    data: JSON.stringify({
                        userId: userId,
                        search: search,
                        price: price,
                        page: page
                    }),
                    success: function(response) {
                        if (response.success) {
                            $('#productContainer').empty();
                            let productHtml = '<div class="row">';
                            response.products.forEach(product => {
                                const modalId = "productModal" + product.prod_id;
                                productHtml += `
                                    <div class="col-lg-3 col-md-6 mb-4 d-flex">
                                        <div class="card h-100 w-100" data-bs-toggle="modal" data-bs-target="#${modalId}" style="cursor:pointer;">
                                            <div class="view overlay">
                                                <img src="${product.prod_picture}" class="card-img-top" alt="">
                                            </div>
                                            <div class="card-body text-center">
                                                <h5>${product.prod_stock} in stock</h5>
                                                <h5><strong>${product.prod_name}</strong></h5>
                                                <p>${product.prod_description}</p>
                                                <p>₱ ${product.prod_price}</p>
                                            </div>
                                        </div>
                                    </div>`;
                            });
                            productHtml += '</div>'; // Close the row
                            $('#productContainer').html(productHtml); // Add products to the container

                            setupPagination(response.pagination);
                        } else {
                            $('#productContainer').html('<p class="text-center">' + response.message + '</p>');
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Error loading products:', error);
                        $('#productContainer').html('<p class="text-center">Error loading products.</p>');
                    }
                });
            }

            function setupPagination(pagination) {
                const paginationContainer = $('#pagination');
                paginationContainer.empty(); // Clear previous pagination

                let paginationHtml = '<nav class="d-flex justify-content-center mt-4"><ul class="pagination pg-blue">';
                
                // Previous button
                if (pagination.currentPage > 1) {
                    paginationHtml += `<li class="page-item"><a class="page-link pagination-link" href="#" data-page="${pagination.currentPage - 1}" aria-label="Previous">&laquo;</a></li>`;
                } else {
                    paginationHtml += `<li class="page-item disabled"><a class="page-link" href="#" aria-label="Previous">&laquo;</a></li>`;
                }

                // Page number links
                for (let i = 1; i <= pagination.totalPages; i++) {
                    const active = (i === pagination.currentPage) ? 'active' : '';
                    paginationHtml += `<li class="page-item ${active}"><a class="page-link pagination-link" href="#" data-page="${i}">${i}</a></li>`;
                }

                // Next button
                if (pagination.currentPage < pagination.totalPages) {
                    paginationHtml += `<li class="page-item"><a class="page-link pagination-link" href="#" data-page="${pagination.currentPage + 1}" aria-label="Next">&raquo;</a></li>`;
                } else {
                    paginationHtml += `<li class="page-item disabled"><a class="page-link" href="#" aria-label="Next">&raquo;</a></li>`;
                }

                paginationHtml += '</ul></nav>';
                paginationContainer.html(paginationHtml); // Add pagination to the container
            }

            // Handle product addition
             $('#addproduct').on('submit', function(e) {
                e.preventDefault(); // Prevent normal form submission
                addProduct(); // Call the function to add the product
            });
            function addProduct(form) {
                const formData = new FormData(form);
                fetch('api/seller_uploadprod.php', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        loadProducts();
                        $('#addproduct').modal('hide');
                    } else {
                        alert(data.message);
                    }
                })
                .catch(error => {
                    console.error('Error adding product:', error);
                    alert('An error occurred while adding the product.');
                });
            }
        });

    </script>

    <?php include("seller_footer.php") ?>

    <script src="asset/js/plugins/apexcharts.min.js"></script>
    <script src="asset/js/pages/dashboard-default.js"></script>
    <script src="asset/js/plugins/popper.min.js"></script>
    <script src="asset/js/plugins/simplebar.min.js"></script>
    <script src="asset/js/plugins/bootstrap.min.js"></script>
    <script src="asset/js/fonts/custom-font.js"></script>
    <script src="asset/js/pcoded.js"></script>
    <script src="asset/js/plugins/feather.min.js"></script>
    <script>
        layout_change('light');
        change_box_container('false');
        layout_rtl_change('false');
        preset_change("preset-1");
        font_change("Public-Sans");
    </script>
</body>

</html>